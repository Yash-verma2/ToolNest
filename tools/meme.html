<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meme Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load necessary fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Impact&family=Inter:wght@400;500;700&family=Arial+Black&family=Comic+Sans+MS&display=swap" rel="stylesheet">
    
    <script>
        // Custom Tailwind Configuration to match specific color requirements
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Custom Light Mode Sky Blue Accent
                        'sky-primary-light': '#0369a1',
                        // Custom Dark Mode Sky Blue Accent
                        'sky-primary-dark': '#60a5fa',
                        // Custom Dark Mode Background
                        'bg-dark-page': '#070c13',
                    },
                },
            },
        }
    </script>

    <style>
        /* Apply Inter as the default font */
        body {
            font-family: 'Inter', sans-serif;
            /* Light Mode: Page background gradient from-gray-100 to-white */
            background-image: linear-gradient(to bottom right, #f3f4f6, #ffffff);
        }
        
        /* Dark Mode Override for Page Background */
        .dark body {
            background-image: none;
            background-color: #070c13; /* Custom bg-dark-page */
        }

        /* Custom scrollbar for template list */
        .template-list::-webkit-scrollbar {
            width: 6px;
        }
        .template-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.8); /* Light mode track (within glass card) */
        }
        .dark .template-list::-webkit-scrollbar-track {
            background: rgba(7,12,19,0.5); /* Dark mode track (within glass card) */
        }
        .template-list::-webkit-scrollbar-thumb {
            background: #9ca3af; /* Light mode thumb */
            border-radius: 3px;
        }
        .dark .template-list::-webkit-scrollbar-thumb {
            background: #6b7280; /* Dark mode thumb */
        }
        .template-list::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }
    </style>
</head>
<!-- Apply Page Background Classes -->
<body class="h-full text-gray-900 dark:text-gray-300 p-4 sm:p-6 lg:p-8 transition-colors duration-300">
    <div class="max-w-7xl mx-auto">
        
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6">
            <div class="text-center sm:text-left mb-4 sm:mb-0">
                <h1 class="text-4xl sm:text-5xl font-bold tracking-tight text-gray-900 dark:text-white transition-colors duration-300">
                    Meme Generator
                </h1>
                <p class="text-lg mt-2 text-gray-600 dark:text-gray-400 transition-colors duration-300">
                    Create your own meme and download it!
                </p>
                <!-- Hero Glow Effect (Subtle radial gradient) -->
                <div class="absolute inset-0 -z-10 pointer-events-none opacity-0 dark:opacity-10 transition-opacity duration-500" style="background: radial-gradient(circle at 50% 10%, rgba(96,165,250,0.14) 0%, transparent 70%);"></div>
            </div>
             
            <!-- Button Group for Navigation and Theme Toggle -->
            <div class="flex items-center space-x-4">
                <!-- NEW: Navigation Back Button (Sky Blue Accent) -->
                <button id="nav-back-btn" class="p-3 rounded-full bg-white dark:bg-gray-700 text-sky-primary-light dark:text-sky-primary-dark shadow-md hover:ring-2 ring-sky-primary-light dark:ring-sky-primary-dark transition-all duration-300" aria-label="Go back to previous page">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                </button>

                <!-- Dark Mode Toggle -->
                <button id="theme-toggle" class="p-3 rounded-full bg-white dark:bg-gray-700 text-gray-700 dark:text-sky-primary-dark shadow-md hover:ring-2 ring-sky-primary-light dark:ring-sky-primary-dark transition-all duration-300" aria-label="Toggle dark mode">
                    <svg id="sun-icon" class="w-6 h-6 hidden text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <svg id="moon-icon" class="w-6 h-6 hidden text-sky-primary-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 11.002 11.002 0 0015.354 20.354z"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Content: Layout splits into controls and preview -->
        <main class="flex flex-col lg:flex-row gap-8">

            <!-- Left Column: Controls -->
            <div class="w-full lg:w-1/3 lg:max-w-md flex-shrink-0">
                <!-- Glass Card Backgrounds -->
                <div class="bg-[rgba(255,255,255,0.95)] dark:bg-[rgba(7,12,19,0.7)] backdrop-blur-sm p-6 rounded-2xl shadow-xl space-y-6 lg:sticky lg:top-8 transition-colors duration-300 border border-gray-100 dark:border-gray-700">
                    
                    <!-- 1. Template Picker -->
                    <div>
                        <h2 class="text-xl font-semibold mb-3 text-gray-900 dark:text-white">1. Pick a Template</h2>
                        <div id="template-container" class="template-list grid grid-cols-3 gap-2 max-h-48 overflow-y-auto rounded-lg p-2 bg-gray-200/50 dark:bg-gray-700/50">
                            <!-- Templates will be injected here by JS -->
                        </div>
                    </div>

                    <!-- 2. Or Use Your Own -->
                    <div>
                        <h2 class="text-xl font-semibold mb-3 text-gray-900 dark:text-white">2. Or Use Your Own</h2>
                        <div class="space-y-4">
                            <!-- File Upload (Violet for Tool/Utility Icon) -->
                            <div>
                                <label for="file-upload" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">Upload an image</label>
                                <input id="file-upload" type="file" accept="image/*" class="block w-full text-sm text-gray-500 dark:text-gray-400
                                    file:mr-4 file:py-2 file:px-4
                                    file:rounded-full file:border-0
                                    file:text-sm file:font-semibold
                                    file:bg-violet-600 file:text-white hover:file:bg-violet-700 transition-colors duration-150
                                    cursor-pointer"/>
                            </div>
                            
                            <!-- URL Input -->
                            <div>
                                <label for="url-upload" class="block text-sm font-medium text-gray-600 dark:text-gray-300">Load from URL</label>
                                <input type="text" id="url-upload" placeholder="https://..." class="mt-1 block w-full bg-gray-100/80 dark:bg-gray-700/80 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm p-2.5 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-sky-primary-light dark:focus:ring-sky-primary-dark focus:border-sky-primary-light dark:focus:border-sky-primary-dark transition-colors duration-150">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Note: May not work on all sites due to security (CORS) policies.</p>
                            </div>
                            
                            <!-- Renamed Revert Button (Violet for utility action) -->
                            <div>
                                <button id="revert-btn" class="w-full flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-violet-600 hover:bg-violet-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500 dark:focus:ring-offset-bg-dark-page transition-colors duration-150">
                                    Reset Image and Controls
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 3. Add Text -->
                    <div>
                        <h2 class="text-xl font-semibold mb-3 text-gray-900 dark:text-white">3. Add Text (Drag to move)</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="top-text" class="block text-sm font-medium text-gray-600 dark:text-gray-300">Top Text</label>
                                <textarea id="top-text" rows="2" class="mt-1 block w-full bg-gray-100/80 dark:bg-gray-700/80 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm p-2.5 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-sky-primary-light dark:focus:ring-sky-primary-dark focus:border-sky-primary-light dark:focus:border-sky-primary-dark transition-colors duration-150" placeholder="Text at the top"></textarea>
                            </div>
                            <div>
                                <label for="bottom-text" class="block text-sm font-medium text-gray-600 dark:text-gray-300">Bottom Text</label>
                                <textarea id="bottom-text" rows="2" class="mt-1 block w-full bg-gray-100/80 dark:bg-gray-700/80 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm p-2.5 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-sky-primary-light dark:focus:ring-sky-primary-dark focus:border-sky-primary-light dark:focus:border-sky-primary-dark transition-colors duration-150" placeholder="Text at the bottom"></textarea>
                            </div>
                            <!-- Reset Button - Rose for Destruction/Reset -->
                            <div>
                                <button id="reset-btn" class="w-full flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-rose-600 hover:bg-rose-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-rose-500 dark:focus:ring-offset-bg-dark-page transition-colors duration-150">
                                    Reset All Text and Settings
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Customize -->
                    <div>
                        <h2 class="text-xl font-semibold mb-3 text-gray-900 dark:text-white">4. Customize</h2>
                        <div class="space-y-4">
                            <!-- Font Size -->
                            <div>
                                <label for="font-size" class="block text-sm font-medium text-gray-600 dark:text-gray-300">Font Size: <span id="font-size-label">10</span>%</label>
                                <input id="font-size" type="range" min="1" max="20" value="10" class="w-full h-2 bg-gray-300 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer accent-sky-primary-light dark:accent-sky-primary-dark">
                            </div>
                            <!-- Outline Width Slider -->
                            <div>
                                <label for="outline-width" class="block text-sm font-medium text-gray-600 dark:text-gray-300">Outline Width: <span id="outline-width-label">5</span>%</label>
                                <input id="outline-width" type="range" min="0" max="15" value="5" class="w-full h-2 bg-gray-300 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer accent-sky-primary-light dark:accent-sky-primary-dark">
                            </div>
                            <!-- Text Color -->
                            <div class="flex items-center justify-between">
                                <label for="text-color" class="block text-sm font-medium text-gray-600 dark:text-gray-300">Text Color</label>
                                <input id="text-color" type="color" value="#FFFFFF" class="w-10 h-10 p-0 border-0 bg-transparent rounded-lg cursor-pointer">
                            </div>
                            <!-- Stroke Color -->
                            <div class="flex items-center justify-between">
                                <label for="stroke-color" class="block text-sm font-medium text-gray-600 dark:text-gray-300">Outline Color</label>
                                <input id="stroke-color" type="color" value="#000000" class="w-10 h-10 p-0 border-0 bg-transparent rounded-lg cursor-pointer">
                            </div>
                            <!-- Font Family Select -->
                            <div>
                                <label for="font-family" class="block text-sm font-medium text-gray-600 dark:text-gray-300">Font Family</label>
                                <select id="font-family" class="mt-1 block w-full bg-gray-100/80 dark:bg-gray-700/80 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm p-2.5 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-sky-primary-light dark:focus:ring-sky-primary-dark focus:border-sky-primary-light dark:focus:border-sky-primary-dark transition-colors duration-150">
                                    <option value="Impact">Impact</option>
                                    <option value="Arial Black">Arial Black</option>
                                    <option value="Comic Sans MS">Comic Sans MS</option>
                                    <option value="Inter">Inter</option>
                                </select>
                            </div>
                            <!-- Text Align Select -->
                            <div>
                                <label for="text-align" class="block text-sm font-medium text-gray-600 dark:text-gray-300">Text Alignment</label>
                                <select id="text-align" class="mt-1 block w-full bg-gray-100/80 dark:bg-gray-700/80 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm p-2.5 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-sky-primary-light dark:focus:ring-sky-primary-dark focus:border-sky-primary-light dark:focus:border-sky-primary-dark transition-colors duration-150">
                                    <option value="center">Center</option>
                                    <option value="left">Left</option>
                                    <option value="right">Right</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 5. Download - Emerald/Green for Main Success/Action CTA -->
                    <div>
                        <h2 class="text-xl font-semibold mb-3 text-gray-900 dark:text-white">5. Download</h2>
                        <a id="download-btn" href="#" download="meme.png" class="w-full flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-lg text-white 
                           bg-gradient-to-r from-emerald-600 to-emerald-400 hover:from-emerald-700 hover:to-emerald-500
                           dark:from-emerald-400 dark:to-emerald-300 dark:hover:from-emerald-500 dark:hover:to-emerald-400
                           focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 dark:focus:ring-offset-bg-dark-page transition-all duration-200">
                            Download Meme
                        </a>
                    </div>
                </div>
            </div>

            <!-- Right Column: Canvas Preview -->
            <div class="w-full lg:w-2/3">
                <!-- Glass Card Backgrounds -->
                <div class="bg-[rgba(255,255,255,0.95)] dark:bg-[rgba(7,12,19,0.7)] backdrop-blur-sm p-4 rounded-2xl shadow-xl transition-colors duration-300 border border-gray-100 dark:border-gray-700">
                    <div id="canvas-container" class="w-full h-auto bg-gray-200 dark:bg-gray-900 rounded-lg overflow-hidden">
                        <canvas id="meme-canvas" class="w-full h-auto"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const canvas = document.getElementById('meme-canvas');
            const ctx = canvas.getContext('2d');
            const canvasContainer = document.getElementById('canvas-container');
            const templateContainer = document.getElementById('template-container');
            const fileUpload = document.getElementById('file-upload');
            const urlUpload = document.getElementById('url-upload');
            const topTextEl = document.getElementById('top-text');
            const bottomTextEl = document.getElementById('bottom-text');
            const fontSizeEl = document.getElementById('font-size');
            const fontSizeLabel = document.getElementById('font-size-label');
            const textColorEl = document.getElementById('text-color');
            const strokeColorEl = document.getElementById('stroke-color');
            const outlineWidthEl = document.getElementById('outline-width');
            const outlineWidthLabel = document.getElementById('outline-width-label');
            const fontFamilyEl = document.getElementById('font-family');
            const textAlignEl = document.getElementById('text-align');
            const resetBtn = document.getElementById('reset-btn');
            const downloadBtn = document.getElementById('download-btn');
            const themeToggle = document.getElementById('theme-toggle');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            
            // Renamed and New Buttons
            const revertBtn = document.getElementById('revert-btn'); // Renamed from back-btn
            const navBackBtn = document.getElementById('nav-back-btn'); // New Navigation Back Button
 
            // --- Image Templates ---
            const templates = [
                { name: "Distracted BF", url: "https://i.imgflip.com/1bij.jpg" },
                { name: "Woman/Cat", url: "https://i.imgflip.com/30b1gx.jpg" },
                { name: "Roll Safe", url: "https://i.imgflip.com/1g8my4.jpg" },
                { name: "Two Buttons", url: "https://i.imgflip.com/1g8my4.jpg" },
                { name: "Drake", url: "https://i.imgflip.com/30b1gx.jpg" },
                { name: "Change My Mind", url: "https://i.imgflip.com/24y43o.jpg" },
                { name: "UNO", url: "https://i.imgflip.com/2m60qf.jpg" },
                { name: "Spongebob", url: "https://i.imgflip.com/1otk96.jpg" },
                { name: "Surprised Pikachu", url: "https://i.imgflip.com/2kpr0s.jpg" },
            ];

            // --- State ---
            const img = new Image();
            img.crossOrigin = "anonymous"; // Necessary for loading cross-domain images into canvas
            let topTextPos = { x: 0.5, y: 0.05 }; // Relative positions (0.0 to 1.0)
            let bottomTextPos = { x: 0.5, y: 0.95 };
            let topTextBounds = { x: 0, y: 0, width: 0, height: 0 }; // Absolute pixel bounds
            let bottomTextBounds = { x: 0, y: 0, width: 0, height: 0 };
            let isDragging = false;
            let draggingText = null; // 'top' or 'bottom'
            let dragOffset = { x: 0, y: 0 };
            let currentTemplateIndex = 0; // Track the current template index or -1 for custom

            // --- Core Drawing Function ---
            function drawMeme() {
                if (!img.src || img.naturalWidth === 0) return; // Don't draw if no image is loaded/ready

                // 1. Resize canvas to fit image and container
                const containerWidth = canvasContainer.clientWidth;
                const scale = containerWidth / img.naturalWidth;
                canvas.width = containerWidth;
                canvas.height = img.naturalHeight * scale;

                // 2. Clear canvas and draw image
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                // 3. Set up text style
                const fontSize = (canvas.width * (fontSizeEl.value / 100));
                const strokeWidth = (fontSize * (outlineWidthEl.value / 100));
                const alignment = textAlignEl.value;
                
                ctx.font = `${fontSize}px ${fontFamilyEl.value}`;
                ctx.textAlign = alignment;
                ctx.fillStyle = textColorEl.value;
                ctx.strokeStyle = strokeColorEl.value;
                ctx.lineWidth = strokeWidth;
                const maxWidth = canvas.width * 0.9;
 
                // 4. Draw Top Text
                const topText = topTextEl.value.toUpperCase();
                const topX_abs = topTextPos.x * canvas.width;
                const topY_abs = topTextPos.y * canvas.height;
                ctx.textBaseline = 'top';
                const topMetrics = wrapText(ctx, topText, topX_abs, topY_abs, maxWidth, fontSize, false);
                
                let topBoundsX = topX_abs - (alignment === 'center' ? topMetrics.width / 2 : (alignment === 'right' ? topMetrics.width : 0));
                
                topTextBounds = {
                    x: topBoundsX,
                    y: topY_abs,
                    width: topMetrics.width,
                    height: topMetrics.height
                };
                
                // 5. Draw Bottom Text
                const bottomText = bottomTextEl.value.toUpperCase();
                const bottomX_abs = bottomTextPos.x * canvas.width;
                const bottomY_abs = bottomTextPos.y * canvas.height;
                ctx.textBaseline = 'bottom';
                const bottomMetrics = wrapText(ctx, bottomText, bottomX_abs, bottomY_abs, maxWidth, fontSize, true);

                let bottomBoundsX = bottomX_abs - (alignment === 'center' ? bottomMetrics.width / 2 : (alignment === 'right' ? bottomMetrics.width : 0));

                bottomTextBounds = {
                    x: bottomBoundsX,
                    y: bottomY_abs - bottomMetrics.height,
                    width: bottomMetrics.width,
                    height: bottomMetrics.height
                };
            
                // 6. Update download button
                updateDownloadLink();
            }

            function wrapText(context, text, x, y, maxWidth, lineHeight, fromBottom) {
                const lines = [];
                const words = text.split(' ');
                let currentLine = '';
                let maxWidthUsed = 0;

                for (let i = 0; i < words.length; i++) {
                    const testLine = currentLine + words[i] + ' ';
                    const metrics = context.measureText(testLine);
                    const testWidth = metrics.width;
                    
                    if (testWidth > maxWidth && i > 0) {
                        lines.push(currentLine.trim());
                        maxWidthUsed = Math.max(maxWidthUsed, context.measureText(currentLine.trim()).width);
                        currentLine = words[i] + ' ';
                    } else {
                        currentLine = testLine;
                    }
                }
                lines.push(currentLine.trim());
                maxWidthUsed = Math.max(maxWidthUsed, context.measureText(currentLine.trim()).width);

                if (fromBottom) {
                    for (let i = lines.length - 1; i >= 0; i--) {
                        const lineY = y - (lines.length - 1 - i) * lineHeight;
                        context.strokeText(lines[i], x, lineY);
                        context.fillText(lines[i], x, lineY);
                    }
                } else {
                    for (let i = 0; i < lines.length; i++) {
                        const lineY = y + i * lineHeight;
                        context.strokeText(lines[i], x, lineY);
                        context.fillText(lines[i], x, lineY);
                    }
                }

                return {
                    width: maxWidthUsed,
                    height: lines.length * lineHeight
                };
            }

            function resetControls() {
                topTextEl.value = '';
                bottomTextEl.value = '';
                topTextPos = { x: 0.5, y: 0.05 };
                bottomTextPos = { x: 0.5, y: 0.95 };
                fontSizeEl.value = 10;
                fontSizeLabel.textContent = 10;
                outlineWidthEl.value = 5;
                outlineWidthLabel.textContent = 5;
                textColorEl.value = '#FFFFFF';
                strokeColorEl.value = '#000000';
                fontFamilyEl.value = 'Impact';
                textAlignEl.value = 'center';
            }
 
            // --- Drag and Drop Handlers ---
            function getMousePos(canvasEl, evt) {
                const rect = canvasEl.getBoundingClientRect();
                const scaleX = canvasEl.width / rect.width;
                const scaleY = canvasEl.height / rect.height;
                const clientX = evt.clientX || (evt.touches && evt.touches[0] ? evt.touches[0].clientX : 0);
                const clientY = evt.clientY || (evt.touches && evt.touches[0] ? evt.touches[0].clientY : 0);
                
                return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY
                };
            }

            function isPointInBounds(x, y, bounds) {
                return x >= bounds.x && x <= bounds.x + bounds.width &&
                       y >= bounds.y && y <= bounds.y + bounds.height;
            }

            function handleMouseDown(e) {
                e.preventDefault();
                const mousePos = getMousePos(canvas, e.touches ? e.touches[0] : e);

                if (isPointInBounds(mousePos.x, mousePos.y, topTextBounds)) {
                    isDragging = true;
                    draggingText = 'top';
                    dragOffset.x = mousePos.x - (topTextPos.x * canvas.width);
                    dragOffset.y = mousePos.y - (topTextPos.y * canvas.height);
                } else if (isPointInBounds(mousePos.x, mousePos.y, bottomTextBounds)) {
                    isDragging = true;
                    draggingText = 'bottom';
                    dragOffset.x = mousePos.x - (bottomTextPos.x * canvas.width);
                    dragOffset.y = mousePos.y - (bottomTextPos.y * canvas.height);
                } else {
                    isDragging = false;
                    draggingText = null;
                }
            }

            function handleMouseUp(e) {
                isDragging = false;
                draggingText = null;
                canvas.style.cursor = 'default';
            }

            function handleMouseMove(e) {
                if (!isDragging || !draggingText) {
                    const mousePos = getMousePos(canvas, e.touches ? e.touches[0] : e);
                    if (isPointInBounds(mousePos.x, mousePos.y, topTextBounds) ||
                        isPointInBounds(mousePos.x, mousePos.y, bottomTextBounds)) {
                        canvas.style.cursor = 'move';
                    } else {
                        canvas.style.cursor = 'default';
                    }
                    return;
                }
                
                e.preventDefault();
                const mousePos = getMousePos(canvas, e.touches ? e.touches[0] : e);
                canvas.style.cursor = 'move';

                const newX_abs = mousePos.x - dragOffset.x;
                const newY_abs = mousePos.y - dragOffset.y;
                const newX_rel = newX_abs / canvas.width;
                const newY_rel = newY_abs / canvas.height;

                if (draggingText === 'top') {
                    topTextPos.x = newX_rel;
                    topTextPos.y = newY_rel;
                } else if (draggingText === 'bottom') {
                    bottomTextPos.x = newX_rel;
                    bottomTextPos.y = newY_rel;
                }
                drawMeme();
            }

            // --- Theme/Dark Mode Logic ---
            function toggleDarkMode() {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                updateThemeIcons(isDark);
            }

            function updateThemeIcons(isDark) {
                if (isDark) {
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                } else {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                }
            }

            function applyInitialTheme() {
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                    document.documentElement.classList.add('dark');
                    updateThemeIcons(true);
                } else {
                    document.documentElement.classList.remove('dark');
                    updateThemeIcons(false);
                }
            }

            themeToggle.addEventListener('click', toggleDarkMode);


            // --- Event Listeners ---

            // Redraw when image finishes loading
            img.onload = drawMeme;

            // Add drag/drop listeners
            canvas.addEventListener('mousedown', handleMouseDown, { passive: false });
            canvas.addEventListener('mouseup', handleMouseUp, { passive: false });
            canvas.addEventListener('mouseleave', handleMouseUp, { passive: false });
            canvas.addEventListener('mousemove', handleMouseMove, { passive: false });
            canvas.addEventListener('touchstart', handleMouseDown, { passive: false });
            canvas.addEventListener('touchend', handleMouseUp, { passive: false });
            canvas.addEventListener('touchmove', handleMouseMove, { passive: false });

            // Redraw when any text or style input changes
            [topTextEl, bottomTextEl, fontSizeEl, textColorEl, strokeColorEl, outlineWidthEl, fontFamilyEl, textAlignEl].forEach(el => {
                el.addEventListener('input', drawMeme);
            });
 
            // Update slider labels
            fontSizeEl.addEventListener('input', (e) => {
                fontSizeLabel.textContent = e.target.value;
            });
            outlineWidthEl.addEventListener('input', (e) => {
                outlineWidthLabel.textContent = e.target.value;
            });

            // Reset Text and Settings Button Listener
            resetBtn.addEventListener('click', () => {
                resetControls();
                drawMeme();
            });

            // Revert Image Button Listener (renamed)
            revertBtn.addEventListener('click', () => {
                img.src = templates[0].url; // Load the first template image
                fileUpload.value = '';
                urlUpload.value = '';
                resetControls();
                currentTemplateIndex = 0;
            });
            
            // NEW: Navigation Back Button Listener
            navBackBtn.addEventListener('click', () => {
                window.history.back();
            });

            // Handle File Upload
            fileUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        img.src = event.target.result;
                        urlUpload.value = '';
                        resetControls();
                        currentTemplateIndex = -1; // Indicate custom image
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Handle URL Upload
            urlUpload.addEventListener('change', (e) => {
                const url = e.target.value;
                try {
                    new URL(url);
                    img.src = url;
                    fileUpload.value = '';
                    resetControls();
                    currentTemplateIndex = -1; // Indicate custom image
                } catch (_) {
                    console.warn("Invalid URL entered");
                }
            });

            // Redraw canvas on window resize
            window.addEventListener('resize', drawMeme);

            // Update download link
            function updateDownloadLink() {
                setTimeout(() => {
                    try {
                        const dataURL = canvas.toDataURL('image/png');
                        downloadBtn.href = dataURL;
                    } catch (err) {
                        console.error("Error creating data URL (CORS issue likely):", err);
                    }
                }, 100);
            }

            // --- Initialization ---
            function initialize() {
                applyInitialTheme();
                // 1. Populate Templates
                templates.forEach((template, index) => {
                    const btn = document.createElement('button');
                    // Use custom accent color for focus ring
                    btn.className = 'rounded-lg overflow-hidden focus:outline-none focus:ring-2 focus:ring-sky-primary-light dark:focus:ring-sky-primary-dark transition-transform duration-150 ease-in-out hover:scale-105';
                    btn.setAttribute('aria-label', `Use ${template.name} template`);
                    
                    const imgEl = document.createElement('img');
                    imgEl.src = template.url;
                    imgEl.alt = template.name;
                    imgEl.className = 'w-full h-full object-cover aspect-square';
                    imgEl.crossOrigin = "anonymous";
                    
                    btn.appendChild(imgEl);
                    
                    btn.addEventListener('click', () => {
                        img.src = template.url;
                        fileUpload.value = '';
                        urlUpload.value = '';
                        resetControls();
                        currentTemplateIndex = index;
                    });
                    
                    templateContainer.appendChild(btn);
                });

                // 2. Load the first template image by default
                if (templates.length > 0) {
                    img.src = templates[0].url;
                }
            }

            initialize();
        });
    </script>
</body>
</html>